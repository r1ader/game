<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!--    <script src="js/Rcanvas/Rcanvas.js"></script>-->
    <title>Document</title>
    <style>
        #main {
            border: 1px solid black;
        }

        .dir {
            height: 50px;
            width: 50px;
            font-size: 50px;
            /*background-color: aqua;*/
            display: none;
        }
    </style>
</head>
<body>
<div>
    <div id="q" class="dir">q</div>
    <div id="w" class="dir">w</div>
    <div id="e" class="dir">e</div>
    <br>
    <div id="a" class="dir">a</div>
    <div id="s" class="dir">s</div>
    <div id="d" class="dir">d</div>
    <div id="f" class="dir">F</div>
    <div id="left" class="dir">L</div>
    <div id="test" class="dir"></div>
</div>
<h1>wasd控制位置，f落子</h1>
<canvas id="main" width="1200" height="900"></canvas>
</body>
<script>
    {
        var test = document.getElementById('test');
        var c = document.getElementById('main');
        var ctx = c.getContext('2d');
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, 1200, 900);
        var timeline = 0;
        var passx = 0;
        var passy = 0;
        var mousex = 0;
        var mousey = 0;
        var keyw = 0;   //是否按下W建
        var keya = 0;
        var keys = 0;
        var keyd = 0;
        var keyf = 0;
        var keyq = 0;
        var keye = 0;
        var mouse_left = 0; //是否按下鼠标左键
        var p = new Array();
        var l = new Array();
        var p_num = 0;
        var l_num = 0;
        var quality = 1;
        var anime_next_change_on = 0;
        var anime_piece_change_on = 0;

        // link()
        function Point(a, b, c) {
            this.x = a;
            this.y = b;
            this.z = c;
        }

        function Line(a, b) {
            this.start = a;
            this.end = b;
        }

        function Piece(a, b, c) {
            this.x = a;
            this.y = b;
            this.z = c;
            this.is_draw = true;
            this.on = function () {
                this.is_draw = true;
            };
            this.off = function () {
                this.is_draw = true;
            };
        }

        function Dir(a, b, c) {
            this.x = a;
            this.y = b;
            this.z = c;
            this.z_high = Math.atan2(c, Math.sqrt(b * b + a * a));
            this.xy_rad = Math.atan2(b, a);
            this.dealxyz = function () {
                this.z = Math.sin(this.z_high);
                this.x = Math.cos(this.z_high) * Math.cos(this.xy_rad);
                this.y = Math.cos(this.z_high) * Math.sin(this.xy_rad);
            }
        }

        function add_point(a, b, c) {
            p[p_num] = new Point(a, b, c);
            p_num++;
            return p_num - 1;
        }

        function add_line(a, b) {
            l[l_num] = new Line(a, b);
            l_num++;
        }

        function link(a, b) {
            var x1 = p[a].x;
            var y1 = p[a].y;
            var z1 = p[a].z;
            var x2 = p[b].x;
            var y2 = p[b].y;
            var z2 = p[b].z;
            var lenth = quality * Math.round(Math.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2) + (z1 - z2) * (z1 - z2)));
            for (var i = 0; i < lenth; i++) {
                var temp = new Point(x1 + (x2 - x1) / lenth * i, y1 + (y2 - y1) / lenth * i, z1 + (z2 - z1) / lenth * i);
                point_draw(temp, 2);
            }
        }

        function rotate(po, x, y, z, round, high) {
            var temp_lenth = Math.sqrt((po.x - x) * (po.x - x) + (po.y - y) * (po.y - y) + (po.z - z) * (po.z - z));
            var temp_dir = new Dir(po.x - x, po.y - y, po.z - z);
            temp_dir.xy_rad += round;
            temp_dir.xy_rad = rad_check_2PI(temp_dir.xy_rad);
            temp_dir.z_high += high;
            temp_dir.z_high = rad_check_z_PI(temp_dir.z_high);
            temp_dir.dealxyz();
            po.x = x + temp_lenth * temp_dir.x;
            po.y = y + temp_lenth * temp_dir.y;
            po.z = z + temp_lenth * temp_dir.z;
            return po;
        }

        var me_pos = new Point(-50, -120, 50);
        var me_dir = new Dir(0, 1, 0);
        var me_dir_x = new Dir(1, 0, 0);
        var me_dir_z = new Dir(0, 0, 1);
        var me_pass_dir = new Dir(0, 1, 0);

        function rad_check_2PI(tempa) {
            var tempb = tempa;
            if (tempb < 0) tempb += 2 * Math.PI;
            if (tempb >= 2 * Math.PI) tempb -= 2 * Math.PI;
            return tempb;
        }

        function rad_check_z_PI(tempa) {
            var tempb = tempa;
            if (tempb > Math.PI / 2) tempb = Math.PI - tempb;
            if (tempb < Math.PI / -2) tempb = Math.PI + tempb;
            return tempb;
        }

        function point_draw(po, rdo, alpha) {
            if (alpha != 0) alpha = alpha || 1;
            var me_to_p1 = new Point(po.x - me_pos.x, po.y - me_pos.y, po.z - me_pos.z);
            // me_to_p1.dealxyz();
            var final_x = me_to_p1.x * me_dir_x.x + me_to_p1.y * me_dir_x.y + me_to_p1.z * me_dir_x.z;
            var final_y = me_to_p1.x * me_dir.x + me_to_p1.y * me_dir.y + me_to_p1.z * me_dir.z;
            var final_z = me_to_p1.x * me_dir_z.x + me_to_p1.y * me_dir_z.y + me_to_p1.z * me_dir_z.z;
            var final_dir = new Dir(final_x, final_y, final_z);
            final_dir.xy_rad = rad_check_2PI(final_dir.xy_rad);
            final_dir.dealxyz();
            if (final_dir.z_high < Math.PI / 4 && final_dir.z_high > Math.PI / -4) {
                ect_y = 350 - final_dir.z_high * 450 * 2;
                ect_x = (final_dir.xy_rad) * 660 / 1.5 * 2 - 800;
                // ctx.fillStyle = "white";
                // ctx.fillRect(ect_x - rdo / 2, ect_y - rdo / 2, rdo, rdo);
                ctx.fillStyle = 'rgba(255,255,255,' + alpha.toString() + ')';
                ctx.fillRect(ect_x - rdo / 2, ect_y - rdo / 2, rdo, rdo);
            }
        }

        function line_draw(po, po2, rdo, alpha) {
            if (alpha != 0)
                alpha = alpha || 1;
            var x1 = po.x;
            var y1 = po.y;
            var z1 = po.z;
            var x2 = po2.x;
            var y2 = po2.y;
            var z2 = po2.z;
            var lenth = quality * Math.round(Math.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2) + (z1 - z2) * (z1 - z2)));
            for (var i = 0; i < lenth; i++) {
                var temp = new Point(x1 + (x2 - x1) / lenth * i, y1 + (y2 - y1) / lenth * i, z1 + (z2 - z1) / lenth * i);
                point_draw(temp, rdo, alpha);
            }
        }

        function circle_draw(x, y, z, rdo, dir, alpha) {
            var zh = dir.z_high;
            var xy = dir.xy_rad;
            var quality = 1 / (rdo * 2);
            for (var i = 0; i < 2 * Math.PI; i += quality) {
                var ect_zh = rdo * Math.cos(i) * Math.cos(zh);
                if (zh < 0) ect_zh *= -1;
                var ect_rdo = Math.sqrt(rdo * rdo - ect_zh * ect_zh);
                var ect_a = rdo * Math.sin(i);

                var rd = Math.acos(ect_a / ect_rdo);
                var rd = Math.abs(rd);
                if (Math.cos(i) < 0)
                    rd = -1 * rd;
                var temp_p = new Point(x + Math.cos(rd + xy + Math.PI / 2) * Math.abs(ect_rdo), y + Math.sin(rd + xy + Math.PI / 2) * Math.abs(ect_rdo), ect_zh + z);
                point_draw(temp_p, 3, alpha);
            }
        }

        function rect_draw(x, y, alpha) {
            for (var i = 0; i < 10 * quality; i++) {
                line_draw(new Point(x * 10, y * 10 + i / quality, 0), new Point(x * 10 + 10, y * 10 + i / quality, 0), 2, alpha);
                line_draw(new Point(x * 10 + i / quality, y * 10, 0), new Point(x * 10 + i / quality, y * 10 + 10, 0), 2, alpha);
                // console.log("1");
            }
        }
    }

    var draw = function () {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, 1200, 900);
        var ect_x, ect_y;
        for (var i = 0; i < p_num; i++) {
            point_draw(p[i], 4);
        }
        for (var i = 0; i < l_num; i++) {
            link(l[i].start, l[i].end);
        }
        // circle_draw(0,0,0,40,340);
    };

    function show(dir, pos) {
        var zh = (dir.z_high);
        var wid = dir.xy_rad;
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(pos, 100);
        ctx.lineTo(pos + 30 * Math.cos(zh) * Math.cos(wid), 100 + 30 * Math.cos(zh) * Math.sin(wid));
        ctx.closePath();
        ctx.stroke();
    }

    var dir_change = function () {

        var change_x = mousex - passx;
        var change_y = mousey - passy;
        me_dir.z_high = -0.89;
        me_dir.xy_rad = me_pass_dir.xy_rad + change_x / 300;

        me_pos.x = 50 + 90 * Math.cos(me_dir.xy_rad + Math.PI);
        me_pos.y = 50 + 90 * Math.sin(me_dir.xy_rad + Math.PI);
        me_pos.z = 150;
        if (me_dir.z_high > Math.PI / 2)
            me_dir.z_high = Math.PI / 2;
        if (me_dir.z_high < -1 * Math.PI / 2)
            me_dir.z_high = -1 * Math.PI / 2;
        if (me_dir.xy_rad < 0) me_dir.xy_rad += 2 * Math.PI;
        if (me_dir.xy_rad >= 2 * Math.PI) me_dir.xy_rad -= 2 * Math.PI;
        me_dir.dealxyz();


        me_dir_x.z_high = 0;
        me_dir_x.xy_rad = me_dir.xy_rad - Math.PI / 2;
        if (me_dir_x.xy_rad < 0) me_dir_x.xy_rad += 2 * Math.PI;
        if (me_dir_x.xy_rad >= 2 * Math.PI) me_dir_x.xy_rad -= 2 * Math.PI;
        me_dir_x.dealxyz();


        me_dir_z.z_high = Math.PI / 2 - me_dir.z_high;

        me_dir_z.xy_rad = me_dir.xy_rad - Math.PI;
        if (me_dir_z.xy_rad < 0) me_dir_z.xy_rad += 2 * Math.PI;
        if (me_dir_z.xy_rad >= 2 * Math.PI) me_dir_z.xy_rad -= 2 * Math.PI;
        me_dir_z.dealxyz();

        // test.innerText=me_dir_z.z;


        // test.innerText=change_x+" "+change_y;
        // test.innerText= me_dir.z_high+" "+me_dir.xy_rad;
    };

    var pos_change = function () {
        if (keyq) {
            me_pos.x += me_dir.x;
            me_pos.y += me_dir.y;
            me_pos.z += me_dir.z;
        }
        if (keye) {
            me_pos.x -= me_dir.x;
            me_pos.y -= me_dir.y;
            me_pos.z -= me_dir.z;
        }
        if (keyw) {
            me_pos.z += 1;
        }
        if (keys) {
            me_pos.z -= 1;
        }
        if (keyd) {
            me_pos.x -= Math.sin(me_dir.xy_rad);
            me_pos.y += Math.cos(me_dir.xy_rad);
        }
        if (keya) {
            me_pos.x += Math.sin(me_dir.xy_rad);
            me_pos.y -= Math.cos(me_dir.xy_rad);
        }
    };

    var init = function () {
        dir_change();
        for (var i = 0; i < 11; i++) {
            var ta = add_point(i * 10, 0, 0);
            var tb = add_point(i * 10, 100, 0);
            add_line(ta, tb);
            var ta = add_point(0, i * 10, 0);
            var tb = add_point(100, i * 10, 0);
            add_line(ta, tb);
        }

        for (var i = 0; i <= 11; i++) {
            board[i] = new Array();
            for (var j = 0; j <= 11; j++) {
                board[i][j] = 0;
                // 0-empty   1-black  2-white
            }
        }
        //standard
        board[5][5] = 1;
        board[6][6] = 1;
        board[6][5] = 2;
        board[5][6] = 2;

        //test1
        // for (var i = 2; i <= 8; i++) {
            // board[i][10-i]=2;
            // board[i][i]=2;
            // board[5][i]=2;
            // board[i][5]=2;
            // board[5][5]=0;
            // board[1][1]=1;
            // board[5][1]=1;
            // board[1][5]=1;
            // board[9][1]=1;
            // board[1][9]=1;
            // board[9][9]=1;
            // board[5][9]=1;
            // board[9][5]=1;
        // }

        //test2
        // for (var i = 2; i <= 9; i++) {
        //     board[i][i] = 2;
        //     board[1][i] = 2;
        //     board[i][1] = 2;
        //     board[10][10] = 1;
        //     board[10][1] = 1;
        //     board[1][10] = 1;
        //
        // }
    };

    var gui = function () {

        if (keyq)
            document.getElementById('q').style.backgroundColor = 'green';
        else
            document.getElementById('q').style.backgroundColor = 'white';
        if (keye)
            document.getElementById('e').style.backgroundColor = 'green';
        else
            document.getElementById('e').style.backgroundColor = 'white';
        if (keya)
            document.getElementById('a').style.backgroundColor = 'green';
        else
            document.getElementById('a').style.backgroundColor = 'white';
        if (keyw)
            document.getElementById('w').style.backgroundColor = 'green';
        else
            document.getElementById('w').style.backgroundColor = 'white';
        if (keys)
            document.getElementById('s').style.backgroundColor = 'green';
        else
            document.getElementById('s').style.backgroundColor = 'white';
        if (keyd)
            document.getElementById('d').style.backgroundColor = 'green';
        else
            document.getElementById('d').style.backgroundColor = 'white';
        if (mouse_left)
            document.getElementById('left').style.backgroundColor = 'green';
        else
            document.getElementById('left').style.backgroundColor = 'white';
        if (keyf)
            document.getElementById('f').style.backgroundColor = 'green';
        else
            document.getElementById('f').style.backgroundColor = 'white';

    };


    var board = new Array();

    var di = new Array();
    {
        di[0] = [0, 1];
        di[1] = [0, -1];
        di[2] = [1, 0];
        di[3] = [-1, 0];
        di[4] = [1, 1];
        di[5] = [1, -1];
        di[6] = [-1, 1];
        di[7] = [-1, -1];
    }

    var next_piece = new Piece(1, 1, 1);

    var show_board = function () {
        if (next_piece.z % 10 == 1 && timeline > 0)
            circle_draw(next_piece.x * 10 - 5, next_piece.y * 10 - 5, 0, 3.8, new Dir(0, 0, 1), Math.abs((timeline + 75) % 100 - 50) / 50);
        if (next_piece.z % 10 == 2 && timeline > 0) {
            circle_draw(next_piece.x * 10 - 5, next_piece.y * 10 - 5, 0, 3.5, new Dir(0, 0, 1), Math.abs((timeline + 75) % 100 - 50) / 50);
            circle_draw(next_piece.x * 10 - 5, next_piece.y * 10 - 5, 0, 2.1, new Dir(0, 0, 1), Math.abs((timeline + 75) % 100 - 50) / 50);
            circle_draw(next_piece.x * 10 - 5, next_piece.y * 10 - 5, 0, 1.1, new Dir(0, 0, 1), Math.abs((timeline + 75) % 100 - 50) / 50);
            circle_draw(next_piece.x * 10 - 5, next_piece.y * 10 - 5, 0, 0.5, new Dir(0, 0, 1), Math.abs((timeline + 75) % 100 - 50) / 50);
        }
        for (var i = 1; i <= 10; i++) {
            for (var j = 1; j <= 10; j++) {
                if (board[i][j] == 1)
                    circle_draw(i * 10 - 5, j * 10 - 5, 0, 3.5, new Dir(0, 0, 1));
                if (board[i][j] == 2) {
                    circle_draw(i * 10 - 5, j * 10 - 5, 0, 3, new Dir(0, 0, 1));
                    circle_draw(i * 10 - 5, j * 10 - 5, 0, 2, new Dir(0, 0, 1));
                    circle_draw(i * 10 - 5, j * 10 - 5, 0, 1, new Dir(0, 0, 1));
                    circle_draw(i * 10 - 5, j * 10 - 5, 0, 0.5, new Dir(0, 0, 1));
                }
            }
        }
        // rect_draw(next_piece.x-1, next_piece.y-1, Math.abs(timeline % 100 - 50) / 50);
    };

    var play = function () {
        if (timeline >= 0) {
            var nx = next_piece.x;
            var ny = next_piece.y;
            var nz = next_piece.z;
            if (keyd == 1 && next_piece.x > 1) {
                next_piece.x--;
                timeline = -anc.anime_length;
                anc.set_piece(nx, ny, nx - 1, ny);
            }
            else if (keya == 1 && next_piece.x < 10) {
                next_piece.x++;
                timeline = -anc.anime_length;
                anc.set_piece(nx, ny, nx + 1, ny);
            }
            else if (keys == 1 && next_piece.y > 1) {
                next_piece.y--;
                timeline = -anc.anime_length;
                anc.set_piece(nx, ny, nx, ny - 1);
            }
            else if (keyw == 1 && next_piece.y < 10) {
                next_piece.y++;
                timeline = -anc.anime_length;
                anc.set_piece(nx, ny, nx, ny + 1);
            }
            else if (keyf == 1 && board[next_piece.x][next_piece.y] == 0) {
                apc.anime_length = 0;
                board[next_piece.x][next_piece.y] = next_piece.z;
                for (var k = 0; k < 8; k++) {
                    if (board[nx + di[k][0]][ny + di[k][1]] % 10 == 3 - nz)
                        for (var i = 2; nx + i * di[k][0] <= 10 && nx + i * di[k][0] >= 1 && ny + i * di[k][1] <= 10 && ny + i * di[k][1] >= 1; i++) {
                            if (board[nx + i * di[k][0]][ny + i * di[k][1]] % 10 == 0) break;
                        if (board[nx + i * di[k][0]][ny + i * di[k][1]] % 10 == nz) {
                                for (var j = 1; j < i; j++) {
                                    board[nx + j * di[k][0]][ny + j * di[k][1]] = nz + j * 10;
                                    apc.anime_length = apc.anime_length < j ? j : apc.anime_length;
                                }
                                break;
                            }
                        }
                }
                next_piece.z = 3 - next_piece.z;
                apc.anime_length = 20 + apc.anime_length * 10;
                timeline = -apc.anime_length;
                apc.switch = 1;
            }
        }
    };

    var anc = new Anime_next_change(10);

    function Anime_next_change(speed, x1, y1, x2, y2) {
        this.start_x = x1 * 10 - 5;
        this.start_y = y1 * 10 - 5;
        this.end_x = x2 * 10 - 5;
        this.end_y = y2 * 10 - 5;
        this.anime_length = speed;
        this.i = timeline + this.anime_length;
        this.switch = 0;
        this.set_piece = function (x1, y1, x2, y2) {
            this.start_x = x1 * 10 - 5;
            this.start_y = y1 * 10 - 5;
            this.end_x = x2 * 10 - 5;
            this.end_y = y2 * 10 - 5;
            this.switch = 1;
        };
        this.play = function () {
            this.i = timeline + this.anime_length;
            // console.log((this.end_x-this.start_x)/this.anime_length*this.i);
            if (next_piece.z == 1)
                circle_draw(this.start_x + (this.end_x - this.start_x) / this.anime_length * this.i, this.start_y + (this.end_y - this.start_y) / this.anime_length * this.i, 0, 3.8, new Dir(0, 0, 1), 0.5);
            if (next_piece.z == 2) {
                circle_draw(this.start_x + (this.end_x - this.start_x) / this.anime_length * this.i, this.start_y + (this.end_y - this.start_y) / this.anime_length * this.i, 0, 3.8, new Dir(0, 0, 1), 0.5);
                circle_draw(this.start_x + (this.end_x - this.start_x) / this.anime_length * this.i, this.start_y + (this.end_y - this.start_y) / this.anime_length * this.i, 0, 2.1, new Dir(0, 0, 1), 0.5);
                circle_draw(this.start_x + (this.end_x - this.start_x) / this.anime_length * this.i, this.start_y + (this.end_y - this.start_y) / this.anime_length * this.i, 0, 1.1, new Dir(0, 0, 1), 0.5);
                circle_draw(this.start_x + (this.end_x - this.start_x) / this.anime_length * this.i, this.start_y + (this.end_y - this.start_y) / this.anime_length * this.i, 0, 0.5, new Dir(0, 0, 1), 0.5);
            }
        }
    }

    var apc = new Anime_piece_change(100);

    function Anime_piece_change(speed) {
        this.anime_length = speed;
        this.ini = timeline + this.anime_length; //inter_i;
        this.switch = 0;
        this.play = function () {
            this.ini = timeline + this.anime_length;
            for (var i = 1; i <= 10; i++) {
                for (var j = 1; j <= 10; j++) {
                    if (board[i][j] == 0 || board[i][j] == 1 || board[i][j] == 2) continue;
                    var dir_x = 0;
                    if (next_piece.x > i)
                        dir_x = 1;
                    if (next_piece.x < i)
                        dir_x = -1;
                    var dir_y = 0;
                    if (next_piece.y > j)
                        dir_y = 1;
                    if (next_piece.y < j)
                        dir_y = -1;
                    if (board[i][j] % 10 == 1) {
                        var ini_time = this.ini - (board[i][j] - 11) / 1.5;

                        if (ini_time < 0) {
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 3, new Dir(0, 0, 1));
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 2, new Dir(0, 0, 1));
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 1, new Dir(0, 0, 1));
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 0.5, new Dir(0, 0, 1));
                        }
                        else if (ini_time > 30) {
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 3.5, new Dir(0, 0, 1));
                        }
                        else if (ini_time < 15) {

                            var inl_dir = new Dir(dir_x * Math.cos(ini_time / 30 * Math.PI + Math.PI / 2), dir_y * Math.cos(ini_time / 30 * Math.PI + Math.PI / 2), Math.sin(ini_time / 30 * Math.PI + Math.PI / 2));

                            circle_draw(i * 10 - 5, j * 10 - 5, ini_time / 2, 3, inl_dir);
                            circle_draw(i * 10 - 5, j * 10 - 5, ini_time / 2, 2, inl_dir);
                            circle_draw(i * 10 - 5, j * 10 - 5, ini_time / 2, 1, inl_dir);
                            circle_draw(i * 10 - 5, j * 10 - 5, ini_time / 2, 0.5, inl_dir);
                        }
                        else {
                            var inl_dir = new Dir(dir_x * Math.cos(ini_time / 30 * Math.PI + Math.PI / 2), dir_y * Math.cos(ini_time / 30 * Math.PI + Math.PI / 2), Math.sin(ini_time / 30 * Math.PI + Math.PI / 2));
                            circle_draw(i * 10 - 5, j * 10 - 5, (30 - ini_time) / 2, 3.5, inl_dir);
                        }

                        //
                        if (timeline >= -1)
                            board[i][j] %= 10;
                    }
                    if (board[i][j] % 10 == 2) {
                        var ini_time = this.ini - (board[i][j] - 11) / 1.5;
                        if (ini_time > 30) {
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 3, new Dir(0, 0, 1));
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 2, new Dir(0, 0, 1));
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 1, new Dir(0, 0, 1));
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 0.5, new Dir(0, 0, 1));
                        }
                        else if (ini_time < 0) {
                            circle_draw(i * 10 - 5, j * 10 - 5, 0, 3.5, new Dir(0, 0, 1));
                        }
                        else if (ini_time > 15) {
                            var inl_dir = new Dir(dir_x * Math.cos(ini_time / 30 * Math.PI + Math.PI / 2), dir_y * Math.cos(ini_time / 30 * Math.PI + Math.PI / 2), Math.sin(ini_time / 30 * Math.PI + Math.PI / 2));
                            circle_draw(i * 10 - 5, j * 10 - 5, (30 - ini_time) / 2, 3, inl_dir);
                            circle_draw(i * 10 - 5, j * 10 - 5, (30 - ini_time) / 2, 2, inl_dir);
                            circle_draw(i * 10 - 5, j * 10 - 5, (30 - ini_time) / 2, 1, inl_dir);
                            circle_draw(i * 10 - 5, j * 10 - 5, (30 - ini_time) / 2, 0.5, inl_dir);
                        }
                        else {
                            var inl_dir = new Dir(dir_x * Math.cos(ini_time / 30 * Math.PI + Math.PI / 2), dir_y * Math.cos(ini_time / 30 * Math.PI + Math.PI / 2), Math.sin(ini_time / 30 * Math.PI + Math.PI / 2));
                            circle_draw(i * 10 - 5, j * 10 - 5, (ini_time) / 2, 3.5, inl_dir);
                        }

                        //
                        if (timeline >= -1)
                            board[i][j] %= 10;
                    }
                }
            }
        };

    }

    var time_flash = function () {
        timeline++;
        fps_counter++;
        if (timeline > 0) {
            anc.switch = 0;
            apc.switch = 0;
        }

        if (timeline > 10000)
            timeline = 0;
        // test.innerText = timeline;
    };

    var pr = function () {
        time_flash();
        gui();      //显示此时操作
        window.requestAnimationFrame(pr);
        if (mouse_left == 1)
            dir_change();
        draw();
        show_board();
        play();
        if (anc.switch == 1)
            anc.play();
        if (apc.switch == 1)
            apc.play();
    };

    var fps_counter = 0;
    var fps = setInterval(function () {
            test.innerText = fps_counter*4;
        fps_counter = 0;
    }, 250);



    document.onkeydown = function (event) {
        var e = e || event;
//        console.log(e.keyCode);
        var speed = 10;
        if (e && e.keyCode == 87) { // 按 w
            keyw = 1;
        }
        if (e && e.keyCode == 83) { // 按 s
            keys = 1;
        }
        if (e && e.keyCode == 68) { // 按 d
            keyd = 1;
        }
        if (e && e.keyCode == 65) { // 按 a
            keya = 1;
        }
        if (e && e.keyCode == 70) { // 按 f
            keyf = 1;
        }
        if (e && e.keyCode == 81) { // 按 q
            keyq = 1;
        }
        if (e && e.keyCode == 69) { // 按 e
            keye = 1;
        }

    };

    document.onkeyup = function (event) {
        var e = e || event;
        if (e && e.keyCode == 87) { // 松开 w
            keyw = 0;
        }
        if (e && e.keyCode == 83) { // 松开 s
            keys = 0;
        }
        if (e && e.keyCode == 68) { // 松开 d
            keyd = 0;
        }
        if (e && e.keyCode == 65) { // 松开 a
            keya = 0;
        }
        if (e && e.keyCode == 70) { // 按 f
            keyf = 0;
        }
        if (e && e.keyCode == 81) { // 按 q
            keyq = 0;
        }
        if (e && e.keyCode == 69) { // 按 e
            keye = 0;
        }
    };

    document.onmousemove = function (e) {
        e = e || window.event;
        var rc = c.getBoundingClientRect();
        mousex = Math.floor(e.clientX - rc.left);//获取鼠标在canvsa中的坐标
        mousey = Math.floor(e.clientY - rc.top);
//        console.log(me.dir);
    };

    document.onmousedown = function (e) {
        mouse_left = 1;
        passx = mousex;
        passy = mousey;
        me_pass_dir.xy_rad = me_dir.xy_rad;
        me_pass_dir.z_high = me_dir.z_high;

    };

    document.onmouseup = function (e) {
        mouse_left = 0;
    };

    init();

    pr();
</script>
</html>